<!DOCTYPE html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>商品列表 - YY商城</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        .product-card {
            transition: transform 0.2s;
        }
        .product-card:hover {
            transform: translateY(-5px);
        }
        .product-image {
            height: 200px;
            object-fit: cover;
        }
        .guest-message {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
        .category-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .category-food {
            background-color: #28a745;
            color: white;
        }
        .category-toy {
            background-color: #17a2b8;
            color: white;
        }
        .category-ebook {
            background-color: #6f42c1;
            color: white;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container">
            <a class="navbar-brand" href="/">YY商城</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/products">商品列表</a>
                    </li>
                </ul>
                <div class="d-flex">
                    <span id="userInfo" class="text-white me-3" th:text="${#authentication.name}"></span>
                    <button id="logoutBtn" class="btn btn-outline-light">登出</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- 訪客提示訊息 -->
        <div id="guestMessage" class="guest-message" sec:authorize="!isAuthenticated()">
            <h4>歡迎來到 YY商城！</h4>
            <p>您目前以訪客身份瀏覽，只能查看部分商品。</p>
            <p>立即 <a href="/login" class="btn btn-success btn-sm">登入</a> 或 <a href="/register" class="btn btn-outline-success btn-sm">註冊</a> 以查看完整商品列表！</p>
        </div>

        <!-- 搜尋和篩選區 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="input-group" sec:authorize="isAuthenticated()">
                    <input type="text" id="searchInput" class="form-control" placeholder="搜尋商品...">
                    <button class="btn btn-success" type="button" id="searchBtn">
                        <i class="bi bi-search"></i> 搜尋
                    </button>
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex justify-content-end align-items-center">
                    <!-- 分類篩選按鈕 -->
                    <div class="btn-group me-3" sec:authorize="isAuthenticated()">
                        <button type="button" class="btn btn-outline-success active" data-category="ALL">全部</button>
                        <button type="button" class="btn btn-outline-success" data-category="FOOD">食物</button>
                        <button type="button" class="btn btn-outline-success" data-category="TOY">玩具</button>
                        <button type="button" class="btn btn-outline-success" data-category="E_BOOK">電子書</button>
                    </div>
                    <button id="addProductBtn" class="btn btn-success" sec:authorize="hasAnyRole('ADMIN', 'MERCHANT')">
                        <i class="bi bi-plus-lg"></i> 新增商品
                    </button>
                </div>
            </div>
        </div>

        <!-- 商品列表 -->
        <div class="row" id="productList">
            <!-- 商品卡片由 JavaScript 生成 -->
        </div>

        <!-- 分頁 -->
        <nav class="mt-4" sec:authorize="isAuthenticated()">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- 分頁按鈕由 JavaScript 生成 -->
            </ul>
        </nav>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        $(document).ready(function() {
            let currentPage = 1;
            const pageSize = 12;
            let currentCategory = 'ALL';  // 當前選擇的分類

            // 設置全局 AJAX 請求頭
            const token = localStorage.getItem('jwt');
            if (token) {
                $.ajaxSetup({
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader('Authorization', 'Bearer ' + token);
                    }
                });
            }

            // 載入商品列表
            function loadProducts(page = 1) {
                console.log('開始載入商品，頁碼：', page);

                let url = `/api/products?page=${page - 1}&size=${pageSize}`;

                // 添加分類參數
                if (currentCategory !== 'ALL') {
                    url += `&category=${currentCategory}`;
                }

                // 添加搜尋參數
                const searchTerm = $('#searchInput').val();
                if (searchTerm) {
                    url += `&search=${encodeURIComponent(searchTerm)}`;
                }

                $.ajax({
                    url: url,
                    method: 'GET',
                    success: function(response) {
                        console.log('成功獲取商品數據：', response);
                        if (response && response.products) {
                            displayProducts(response.products);
                            displayPagination(response.totalPages, page);
                        } else {
                            console.error('返回數據格式不正確：', response);
                            $('#productList').html('<div class="col-12 text-center"><p class="text-danger">數據格式錯誤</p></div>');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('載入商品失敗:', {
                            status: status,
                            error: error,
                            response: xhr.responseText
                        });
                        $('#productList').html('<div class="col-12 text-center"><p class="text-danger">載入商品失敗，請稍後再試</p></div>');
                    }
                });
            }

            // 顯示商品
            function displayProducts(products) {
                console.log('開始顯示商品，商品數量：', products.length);
                const $productList = $('#productList');
                $productList.empty();

                if (products.length === 0) {
                    $productList.html('<div class="col-12 text-center"><p>找不到商品</p></div>');
                    return;
                }

                products.forEach(product => {
                    const productCard = createProductCard(product);
                    $productList.append(productCard);
                });
            }

            function createProductCard(product) {
                // 轉換分類名稱為中文
                let categoryText = '';
                let categoryClass = '';
                switch(product.category) {
                    case 'FOOD':
                        categoryText = '食物';
                        categoryClass = 'category-food';
                        break;
                    case 'TOY':
                        categoryText = '玩具';
                        categoryClass = 'category-toy';
                        break;
                    case 'E_BOOK':
                        categoryText = '電子書';
                        categoryClass = 'category-ebook';
                        break;
                }

                const card = `
                    <div class="col-md-4 mb-4">
                        <div class="card product-card h-100">
                            <div class="position-relative">
                                <img src="${product.imageUrl}" class="card-img-top product-image" alt="${product.productName}">
                                <span class="category-badge ${categoryClass}">${categoryText}</span>
                            </div>
                            <div class="card-body">
                                <h5 class="card-title">${product.productName}</h5>
                                <p class="card-text">${product.description}</p>
                                <p class="card-text">
                                    <strong>價格：</strong>NT$ ${product.price}<br>
                                    <strong>庫存：</strong>${product.stock}
                                </p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <button class="btn btn-primary" onclick="addToCart(${product.productId})">
                                        <i class="bi bi-cart-plus"></i> 加入購物車
                                    </button>
                                    <div sec:authorize="hasAnyRole('ADMIN', 'MERCHANT')">
                                        <button class="btn btn-warning btn-sm" onclick="editProduct(${product.productId})">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-danger btn-sm" onclick="deleteProduct(${product.productId})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                return card;
            }

            // 顯示分頁
            function displayPagination(totalPages, currentPage) {
                const $pagination = $('#pagination');
                $pagination.empty();

                if (totalPages <= 1) return;

                // 上一頁按鈕
                $pagination.append(`
                    <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" data-page="${currentPage - 1}">上一頁</a>
                    </li>
                `);

                // 頁碼按鈕
                for (let i = 1; i <= totalPages; i++) {
                    $pagination.append(`
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" data-page="${i}">${i}</a>
                        </li>
                    `);
                }

                // 下一頁按鈕
                $pagination.append(`
                    <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                        <a class="page-link" href="#" data-page="${currentPage + 1}">下一頁</a>
                    </li>
                `);
            }

            // 分頁點擊事件
            $('#pagination').on('click', '.page-link', function(e) {
                e.preventDefault();
                const page = $(this).data('page');
                if (page && page > 0) {
                    currentPage = page;
                    loadProducts(page);
                }
            });

            // 分類按鈕點擊事件
            $('.btn-group').on('click', '.btn', function() {
                $('.btn-group .btn').removeClass('active');
                $(this).addClass('active');
                currentCategory = $(this).data('category');
                currentPage = 1;
                loadProducts(1);
            });

            // 搜尋按鈕點擊事件
            $('#searchBtn').click(function() {
                currentPage = 1;
                loadProducts(1);
            });

            // 搜尋輸入框按 Enter 事件
            $('#searchInput').keypress(function(e) {
                if (e.which === 13) {
                    currentPage = 1;
                    loadProducts(1);
                }
            });

            // 新增商品按鈕點擊事件
            $('#addProductBtn').click(function() {
                window.location.href = '/product-form';
            });

            // 登出按鈕點擊事件
            $('#logoutBtn').click(function() {
                localStorage.removeItem('jwt');
                window.location.href = '/login';
            });

            // 初始載入
            loadProducts();
        });

        // 加入購物車
        function addToCart(productId) {
            alert('加入購物車功能開發中...');
        }

        // 編輯商品
        function editProduct(productId) {
            alert('編輯商品功能開發中...');
        }

        // 刪除商品
        function deleteProduct(productId) {
            if (confirm('確定要刪除此商品嗎？')) {
                const token = localStorage.getItem('jwt');
                $.ajax({
                    url: `/api/products/${productId}`,
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    success: function() {
                        alert('商品已刪除');
                        location.reload();
                    },
                    error: function(xhr) {
                        alert('刪除失敗：' + (xhr.responseText || '請稍後再試'));
                    }
                });
            }
        }
    </script>
</body>
</html> 