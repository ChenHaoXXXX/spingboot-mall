<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>商品列表 - YY商城</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        .product-card {
            transition: transform 0.2s;
        }
        .product-card:hover {
            transform: translateY(-5px);
        }
        .product-image {
            height: 200px;
            object-fit: cover;
        }
        .guest-message {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
        .category-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .category-food {
            background-color: #28a745;
            color: white;
        }
        .category-toy {
            background-color: #17a2b8;
            color: white;
        }
        .category-ebook {
            background-color: #6f42c1;
            color: white;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container">
            <a class="navbar-brand" href="/">YY商城</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/products">商品列表</a>
                    </li>
                </ul>
                <div class="d-flex">
                    <span id="userInfo" class="text-white me-3"></span>
                    <button id="logoutBtn" class="btn btn-outline-light d-none">登出</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- 訪客提示訊息 -->
        <div id="guestMessage" class="guest-message d-none">
            <h4>歡迎來到 YY商城！</h4>
            <p>您目前以訪客身份瀏覽，只能查看部分商品。</p>
            <p>立即 <a href="/login" class="btn btn-success btn-sm">登入</a> 或 <a href="/register" class="btn btn-outline-success btn-sm">註冊</a> 以查看完整商品列表！</p>
        </div>

        <!-- 搜尋和篩選區 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="input-group d-none" id="searchGroup">
                    <input type="text" id="searchInput" class="form-control" placeholder="搜尋商品...">
                    <button class="btn btn-success" type="button" id="searchBtn">
                        <i class="bi bi-search"></i> 搜尋
                    </button>
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex justify-content-end align-items-center">
                    <!-- 分類篩選按鈕 -->
                    <div class="btn-group me-3 d-none" id="categoryFilter">
                        <button type="button" class="btn btn-outline-success active" data-category="ALL">全部</button>
                        <button type="button" class="btn btn-outline-success" data-category="FOOD">食物</button>
                        <button type="button" class="btn btn-outline-success" data-category="TOY">玩具</button>
                        <button type="button" class="btn btn-outline-success" data-category="E_BOOK">電子書</button>
                    </div>
                    <button id="addProductBtn" class="btn btn-success d-none">
                        <i class="bi bi-plus-lg"></i> 新增商品
                    </button>
                </div>
            </div>
        </div>

        <!-- 商品列表 -->
        <div class="row" id="productList">
            <!-- 商品卡片由 JavaScript 生成 -->
        </div>

        <!-- 分頁 -->
        <nav class="mt-4">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- 分頁按鈕將由 JavaScript 生成 -->
            </ul>
        </nav>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        $(document).ready(function() {
            let currentPage = 1;
            const pageSize = 12;
            let userRole = '';
            let currentCategory = 'ALL';  // 當前選擇的分類

            // 檢查用戶權限
            function checkUserRole() {
                const token = localStorage.getItem('jwt');
                if (!token) {
                    $('#guestMessage').removeClass('d-none');
                    $('#addProductBtn').addClass('d-none');
                    $('#searchGroup').addClass('d-none');
                    $('#categoryFilter').addClass('d-none');
                    return;
                }

                try {
                    const base64Url = token.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const payload = JSON.parse(atob(base64));
                    userRole = payload.roles[0];

                    $('#guestMessage').addClass('d-none');
                    $('#searchGroup').removeClass('d-none');
                    $('#categoryFilter').removeClass('d-none');

                    if (userRole === 'ROLE_ADMIN' || userRole === 'ROLE_MERCHANT') {
                        $('#addProductBtn').removeClass('d-none');
                    } else {
                        $('#addProductBtn').addClass('d-none');
                    }
                } catch (error) {
                    console.error('解析 token 時發生錯誤:', error);
                    userRole = 'ROLE_GUEST';
                    $('#addProductBtn').addClass('d-none');
                    $('#guestMessage').removeClass('d-none');
                    $('#searchGroup').addClass('d-none');
                    $('#categoryFilter').addClass('d-none');
                }
            }

            // 載入商品列表
            function loadProducts(page = 1) {
                const token = localStorage.getItem('jwt');
                const headers = token ? { 'Authorization': `Bearer ${token}` } : {};

                console.log('開始載入商品，頁碼：', page);

                // 如果是訪客，強制使用第一頁
                if (!token) {
                    page = 1;
                }

                let url = `/api/products?page=${page - 1}&size=${pageSize}`;

                // 添加分類參數
                if (currentCategory !== 'ALL') {
                    url += `&category=${currentCategory}`;
                }

                // 添加搜尋參數
                const searchTerm = $('#searchInput').val();
                if (searchTerm) {
                    url += `&search=${encodeURIComponent(searchTerm)}`;
                }

                $.ajax({
                    url: url,
                    method: 'GET',
                    headers: headers,
                    success: function(response) {
                        console.log('成功獲取商品數據：', response);
                        if (response && response.products) {
                            displayProducts(response.products);
                            displayPagination(response.totalPages, page);
                        } else {
                            console.error('返回數據格式不正確：', response);
                            $('#productList').html('<div class="col-12 text-center"><p class="text-danger">數據格式錯誤</p></div>');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('載入商品失敗:', {
                            status: status,
                            error: error,
                            response: xhr.responseText
                        });
                        $('#productList').html('<div class="col-12 text-center"><p class="text-danger">載入商品失敗，請稍後再試</p></div>');
                    }
                });
            }

            // 顯示商品
            function displayProducts(products) {
                console.log('開始顯示商品，商品數量：', products.length);
                const $productList = $('#productList');
                $productList.empty();

                if (products.length === 0) {
                    $productList.html('<div class="col-12 text-center"><p>找不到商品</p></div>');
                    return;
                }

                products.forEach(product => {
                    const productCard = createProductCard(product);
                    $productList.append(productCard);
                });
            }

            function createProductCard(product) {
                const token = localStorage.getItem('jwt');
                let userRole = '';

                if (token) {
                    try {
                        const base64Url = token.split('.')[1];
                        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                        const payload = JSON.parse(atob(base64));
                        userRole = payload.roles[0];
                    } catch (error) {
                        console.error('解析用戶角色時發生錯誤:', error);
                    }
                }

                // 轉換分類名稱為中文
                let categoryText = '';
                let categoryClass = '';
                switch(product.category) {
                    case 'FOOD':
                        categoryText = '食物';
                        categoryClass = 'category-food';
                        break;
                    case 'TOY':
                        categoryText = '玩具';
                        categoryClass = 'category-toy';
                        break;
                    case 'E_BOOK':
                        categoryText = '電子書';
                        categoryClass = 'category-ebook';
                        break;
                    default:
                        categoryText = product.category;
                        categoryClass = 'bg-secondary';
                }

                return `
                    <div class="col-md-4 mb-4">
                        <div class="card h-100">
                            <div class="position-relative">
                                <img src="${product.imageUrl}" class="card-img-top" alt="${product.productName}" style="height: 200px; object-fit: cover;">
                                <span class="category-badge ${categoryClass}">${categoryText}</span>
                            </div>
                            <div class="card-body">
                                <h5 class="card-title">${product.productName}</h5>
                                <p class="card-text">${product.description}</p>
                                <p class="card-text">
                                    <small class="text-muted">價格: $${product.price}</small>
                                </p>
                                <p class="card-text">
                                    <small class="text-muted">庫存: ${product.stock}</small>
                                </p>
                            </div>
                            ${userRole === 'ROLE_ADMIN' || userRole === 'ROLE_MERCHANT' ? `
                                <div class="card-footer bg-transparent border-top-0">
                                    <div class="d-flex justify-content-end">
                                        <button class="btn btn-sm btn-outline-primary me-2" onclick="editProduct(${product.productId})">
                                            <i class="bi bi-pencil"></i> 編輯
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${product.productId})">
                                            <i class="bi bi-trash"></i> 刪除
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // 顯示分頁
                function displayPagination(totalPages, currentPage) {
                console.log('顯示分頁，總頁數：', totalPages, '當前頁：', currentPage);
                const $pagination = $('#pagination');
                $pagination.empty();

                // 如果是訪客，不顯示分頁
                if (!localStorage.getItem('jwt')) {
                    return;
                }

                if (totalPages <= 1) {
                    return;
                }

                // 上一頁按鈕
                $pagination.append(`
                    <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" data-page="${currentPage - 1}">上一頁</a>
                    </li>
                `);

                // 頁碼按鈕
                for (let i = 1; i <= totalPages; i++) {
                    $pagination.append(`
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" data-page="${i}">${i}</a>
                        </li>
                    `);
                }

                // 下一頁按鈕
                $pagination.append(`
                    <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                        <a class="page-link" href="#" data-page="${currentPage + 1}">下一頁</a>
                    </li>
                `);
            }

            // 分類按鈕點擊事件
            $('#categoryFilter button').click(function() {
                // 更新按鈕狀態
                $('#categoryFilter button').removeClass('active');
                $(this).addClass('active');

                // 更新當前分類
                currentCategory = $(this).data('category');

                // 重新載入商品
                currentPage = 1;
                loadProducts(currentPage);
            });

            // 搜尋按鈕點擊事件
            $('#searchBtn').click(function() {
                currentPage = 1;
                loadProducts(currentPage);
            });

            // 搜尋框按 Enter 鍵事件
            $('#searchInput').keypress(function(e) {
                if (e.which === 13) {
                    currentPage = 1;
                    loadProducts(currentPage);
                }
            });

            // 顯示用戶資訊
            function displayUserInfo() {
                const token = localStorage.getItem('jwt');
                if (token) {
                    try {
                        const base64Url = token.split('.')[1];
                        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                        const payload = JSON.parse(atob(base64));

                        // 轉換角色名稱
                        const roleNames = payload.roles.map(role => {
                            switch(role) {
                                case 'ROLE_ADMIN':
                                    return '管理員';
                                case 'ROLE_NORMAL_MEMBER':
                                    return '一般會員';
                                case 'ROLE_MERCHANT':
                                    return '店家';
                                default:
                                    return role;
                            }
                        });

                        $('#userInfo').text(`歡迎，${payload.sub} (${roleNames.join(', ')})`);
                        $('#logoutBtn').removeClass('d-none');  // 顯示登出按鈕
                        $('#searchGroup').removeClass('d-none');  // 顯示搜尋欄
                    } catch (error) {
                        console.error('解析用戶資訊時發生錯誤:', error);
                        $('#userInfo').text('訪客');
                        $('#logoutBtn').addClass('d-none');  // 隱藏登出按鈕
                        $('#searchGroup').addClass('d-none');  // 隱藏搜尋欄
                    }
                } else {
                    $('#userInfo').text('訪客');
                    $('#logoutBtn').addClass('d-none');  // 隱藏登出按鈕
                    $('#searchGroup').addClass('d-none');  // 隱藏搜尋欄
                }
            }

            // 分頁點擊事件
            $('#pagination').on('click', '.page-link', function(e) {
                e.preventDefault();
                // 如果是訪客，阻止分頁切換
                if (!localStorage.getItem('jwt')) {
                    return;
                }
                const page = $(this).data('page');
                if (page && page !== currentPage) {
                    currentPage = page;
                    loadProducts(page);
                }
            });

            // 登出
            $('#logoutBtn').click(function() {
                localStorage.removeItem('jwt');
                window.location.href = '/login';
            });

            // 初始化
            checkUserRole();
            displayUserInfo();
            loadProducts(currentPage);
        });

        // 商品相關功能
        function viewProduct(id) {
            window.location.href = `/products/${id}`;
        }

        function editProduct(id) {
            window.location.href = `/products/${id}/edit`;
        }

        function deleteProduct(id) {
            if (confirm('確定要刪除此商品嗎？')) {
                const token = localStorage.getItem('jwt');
                $.ajax({
                    url: `/api/products/${id}`,
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` },
                    success: function() {
                        alert('商品已刪除');
                        location.reload();
                    },
                    error: function(xhr) {
                        alert('刪除失敗：' + (xhr.responseJSON?.message || '未知錯誤'));
                    }
                });
            }
        }
    </script>
</body>
</html> 