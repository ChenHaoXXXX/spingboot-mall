<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新增商品 - Spring Mall</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        .form-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .preview-image {
            max-width: 200px;
            max-height: 200px;
            object-fit: cover;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container">
            <a class="navbar-brand" href="/products">Spring Mall</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/products">返回商品列表</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="form-container">
            <h2 class="mb-4">新增商品</h2>
            <form id="productForm" class="needs-validation" novalidate>
                <div class="mb-3">
                    <label for="productName" class="form-label">商品名稱</label>
                    <input type="text" class="form-control" id="productName" name="productName" required>
                    <div class="invalid-feedback">請輸入商品名稱</div>
                </div>

                <div class="mb-3">
                    <label for="category" class="form-label">商品分類</label>
                    <select class="form-select" id="category" name="category" required>
                        <option value="">請選擇分類</option>
                        <option th:each="category : ${categories}"
                                th:value="${category}"
                                th:text="${category == 'FOOD' ? '食物' :
                                         category == 'TOY' ? '玩具' :
                                         category == 'E_BOOK' ? '電子書' : category}">
                        </option>
                    </select>
                    <div class="invalid-feedback">請選擇商品分類</div>
                </div>

                <div class="mb-3">
                    <label for="price" class="form-label">價格</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control" id="price" name="price" min="0" required>
                        <div class="invalid-feedback">請輸入有效的價格</div>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="stock" class="form-label">庫存</label>
                    <input type="number" class="form-control" id="stock" name="stock" min="0" required>
                    <div class="invalid-feedback">請輸入有效的庫存數量</div>
                </div>

                <div class="mb-3">
                    <label for="imageUrl" class="form-label">商品圖片網址</label>
                    <input type="url" class="form-control" id="imageUrl" name="imageUrl" required>
                    <div class="invalid-feedback">請輸入有效的圖片網址</div>
                    <img id="imagePreview" class="preview-image d-none" alt="商品預覽">
                </div>

                <div class="mb-3">
                    <label for="description" class="form-label">商品描述</label>
                    <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-success">新增商品</button>
                    <a href="/products" class="btn btn-outline-secondary">取消</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        $(document).ready(function() {
            // 檢查用戶權限
            // const token = localStorage.getItem('jwt') || sessionStorage.getItem('jwt');
            // if (!token) {
            //     alert('請先登入');
            //     window.location.href = '/login';
            //     return;
            // }
            //
            // // 驗證用戶角色
            // try {
            //     const base64Url = token.split('.')[1];
            //     const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            //     const payload = JSON.parse(atob(base64));
            //     const userRole = payload.roles[0];
            //
            //     if (userRole !== 'ROLE_ADMIN' && userRole !== 'ROLE_MERCHANT') {
            //         alert('您沒有權限新增商品');
            //         window.location.href = '/products';
            //         return;
            //     }
            // } catch (error) {
            //     console.error('解析 token 時發生錯誤:', error);
            //     alert('驗證失敗，請重新登入');
            //     window.location.href = '/login';
            //     return;
            // }

            // 圖片預覽
            $('#imageUrl').on('input', function() {
                const imageUrl = $(this).val();
                const $preview = $('#imagePreview');

                if (imageUrl) {
                    $preview.attr('src', imageUrl).removeClass('d-none');
                } else {
                    $preview.addClass('d-none');
                }
            });

            // 表單提交
            $('#productForm').on('submit', function(e) {
                e.preventDefault();

                if (!this.checkValidity()) {
                    e.stopPropagation();
                    $(this).addClass('was-validated');
                    return;
                }

                const formData = {
                    productName: $('#productName').val(),
                    category: $('#category').val(),
                    price: parseInt($('#price').val()),
                    stock: parseInt($('#stock').val()),
                    imageUrl: $('#imageUrl').val(),
                    description: $('#description').val()
                };

                $.ajax({
                    url: '/api/products',
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // 'Authorization': `Bearer ${token}`
                    },
                    data: JSON.stringify(formData),
                    success: function(response) {
                        alert('商品新增成功！');
                        window.location.href = '/products';
                    },
                    error: function(xhr) {
                        if (xhr.status === 403) {
                            alert('您沒有權限新增商品');
                            window.location.href = '/products';
                        } else {
                            alert('新增失敗：' + (xhr.responseJSON?.message || '請稍後再試'));
                        }
                    }
                });
            });
        });
    </script>
</body>
</html> 